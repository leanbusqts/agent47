#!/bin/bash

BIN_DIR="$HOME/bin"
AGENT64_HOME="$HOME/.agent64"

# Resolve real path even if agent64 is a symlink
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done

SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

SCRIPTS_DIR="$ROOT_DIR/scripts"
VERSION_FILE="$AGENT64_HOME/VERSION"

# ---------------------------
# Version
# ---------------------------
if [ -f "$VERSION_FILE" ]; then
  AGENT64_VERSION="$(cat "$VERSION_FILE")"
else
  AGENT64_VERSION="unknown"
fi

# ---------------------------
# Help
# ---------------------------
print_help() {
  echo "agent64 - Agent & SDD CLI"
  echo "Version: $AGENT64_VERSION"
  echo ""
  echo "Usage:"
  echo "  agent64 help"
  echo "  agent64 install"
  echo "  agent64 upgrade"
  echo "  agent64 uninstall"
  echo "  agent64 init-agent"
  echo "  agent64 doctor"
  echo ""
}

# ---------------------------
# Install templates
# ---------------------------
install_templates() {
  echo "üì¶ Installing agent64 templates..."

  mkdir -p "$AGENT64_HOME"

  if [ -d "$ROOT_DIR/templates" ]; then
    rm -rf "$AGENT64_HOME/templates"
    cp -R "$ROOT_DIR/templates" "$AGENT64_HOME/"
    echo "‚úÖ Templates installed"
  else
    echo "‚ùå Templates directory not found in repo"
  fi

  if [ -f "$ROOT_DIR/VERSION" ]; then
    cp "$ROOT_DIR/VERSION" "$AGENT64_HOME/VERSION"
    echo "‚úÖ VERSION installed"
  else
    echo "‚ùå VERSION file not found in repo"
  fi
}

# ---------------------------
# Install
# ---------------------------
install_scripts() {
  echo "üì¶ Installing agent64 scripts..."

  mkdir -p "$BIN_DIR"

  for script in add-agent add-spec add-skills add-agent-prompt add-agent-prompt-ss; do
    if [ -f "$SCRIPTS_DIR/$script" ]; then
      cp "$SCRIPTS_DIR/$script" "$BIN_DIR/$script"
      chmod +x "$BIN_DIR/$script"
      echo "‚úÖ Installed $script"
    else
      echo "‚ö†Ô∏è  Script not found: $script"
    fi
  done

  install_templates

  echo "üöÄ agent64 installation complete"
}

# ---------------------------
# Upgrade (reinstall)
# ---------------------------
upgrade() {
  echo "‚¨ÜÔ∏è  Upgrading agent64 scripts..."
  install_scripts
  echo "‚úÖ Upgrade completed"
}

# ---------------------------
# Uninstall
# ---------------------------
uninstall() {
  echo "üóëÔ∏è  Uninstalling agent64 scripts..."

  for script in add-agent add-spec add-skills add-agent-prompt add-agent-prompt-ss; do
    if [ -f "$BIN_DIR/$script" ]; then
      rm "$BIN_DIR/$script"
      echo "‚ùå Removed $script"
    else
      echo "‚ö†Ô∏è  $script not found in $BIN_DIR"
    fi
  done

  echo "‚úÖ agent64 tools removed from system"
}

# ---------------------------
# Init Agent (project)
# ---------------------------
init_agent() {
  echo "üß† Initializing AGENT setup in current directory..."
  add-agent
  echo "‚úÖ AGENT initialized"
}

# ---------------------------
# Doctor
# ---------------------------
doctor() {
  echo "ü©∫ agent64 doctor"
  echo "‚úî Version: $AGENT64_VERSION"

  command -v agent64 >/dev/null \
    && echo "‚úî agent64 in PATH" \
    || echo "‚ùå agent64 not in PATH"

  for script in add-agent add-spec add-skills add-agent-prompt add-agent-prompt-ss; do
    command -v "$script" >/dev/null \
      && echo "‚úî $script available" \
      || echo "‚ùå $script missing"
  done
}

# ---------------------------
# Command router
# ---------------------------
case "$1" in
  help|"")
    print_help
    ;;
  install)
    install_scripts
    ;;
  upgrade)
    upgrade
    ;;
  uninstall)
    uninstall
    ;;
  init-agent)
    init_agent
    ;;
  doctor)
    doctor
    ;;
  *)
    echo "‚ùå Unknown command: $1"
    print_help
    ;;
esac
