#!/bin/bash

AGENT47_HOME="$HOME/.agent47"
TEMPLATES_DIR="$AGENT47_HOME/templates"

FILES=(
  "AGENTS.md"
  "rules-mobile.yaml"
  "rules-frontend.yaml"
  "rules-backend.yaml"
)

WITH_SKILLS=false
PROMPT_CHOICE=""

usage() {
  echo "Usage: add-agent [--with-skills] [--prompt base|skills|sdd]"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --with-skills)
      WITH_SKILLS=true
      shift
      ;;
    --prompt)
      if [[ -z "$2" ]]; then
        usage
        exit 1
      fi
      PROMPT_CHOICE="$2"
      shift 2
      ;;
    *)
      usage
      exit 1
      ;;
  esac
done

echo "üìÅ Initializing agent environment..."

for file in "${FILES[@]}"; do
  if [ -f "$TEMPLATES_DIR/$file" ]; then
    if [ -f "./$file" ]; then
      echo "‚ö†Ô∏è  $file already exists, skipping"
    else
      cp "$TEMPLATES_DIR/$file" .
      echo "‚úÖ Copied: $file"
    fi
  else
    echo "‚ùå Template not found: $file"
  fi
done

# Create README.md if not present
if [ ! -f "README.md" ]; then
  touch README.md
  echo "üìù README.md created"
fi

# Optional: add skills
if [ "$WITH_SKILLS" = true ]; then
  if [ -x "$AGENT47_HOME/scripts/add-skills" ]; then
    "$AGENT47_HOME/scripts/add-skills"
  else
    echo "‚ùå add-skills script not found at $AGENT47_HOME/scripts/add-skills"
  fi
fi

# Optional: add prompt
case "$PROMPT_CHOICE" in
  "")
    ;;
  base)
    if [ -x "$AGENT47_HOME/scripts/add-agent-prompt-base" ]; then
      "$AGENT47_HOME/scripts/add-agent-prompt-base"
    else
      echo "‚ùå add-agent-prompt-base not found at $AGENT47_HOME/scripts/add-agent-prompt-base"
    fi
    ;;
  skills)
    if [ -x "$AGENT47_HOME/scripts/add-agent-prompt-skills" ]; then
      "$AGENT47_HOME/scripts/add-agent-prompt-skills"
    else
      echo "‚ùå add-agent-prompt-skills not found at $AGENT47_HOME/scripts/add-agent-prompt-skills"
    fi
    ;;
  sdd)
    if [ -x "$AGENT47_HOME/scripts/add-agent-prompt-sdd" ]; then
      "$AGENT47_HOME/scripts/add-agent-prompt-sdd"
    else
      echo "‚ùå add-agent-prompt-sdd not found at $AGENT47_HOME/scripts/add-agent-prompt-sdd"
    fi
    ;;
  *)
    echo "‚ùå Invalid prompt choice: $PROMPT_CHOICE (use base|skills|sdd)"
    ;;
esac

echo "‚úÖ Agent environment ready"
