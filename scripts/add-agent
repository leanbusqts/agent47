#!/bin/bash

AGENT47_HOME="$HOME/.agent47"
TEMPLATES_DIR="$AGENT47_HOME/templates"
RULES_TEMPLATES_DIR="$TEMPLATES_DIR/rules"

FILES=(
  "rules-mobile.yaml"
  "rules-frontend.yaml"
  "rules-backend.yaml"
)

RULES_DIR="rules"
WITH_SKILLS=false
PROMPT_CHOICE=""

run_helper() {
  local cmd="$1"
  local fallback="$2"
  local args=("${@:3}")

  if command -v "$cmd" >/dev/null 2>&1; then
    "$cmd" "${args[@]}"
    return $?
  fi

  if [ -n "$fallback" ] && [ -x "$fallback" ]; then
    "$fallback" "${args[@]}"
    return $?
  fi

  echo "[ERR] $cmd not found (checked PATH${fallback:+ and $fallback})"
  return 1
}

usage() {
  echo "Usage: add-agent [--with-skills] [--prompt base|skills|sdd]"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --with-skills)
      WITH_SKILLS=true
      shift
      ;;
    --prompt)
      if [[ -z "$2" ]]; then
        usage
        exit 1
      fi
      PROMPT_CHOICE="$2"
      shift 2
      ;;
    *)
      usage
      exit 1
      ;;
  esac
done

echo "[INFO] Initializing agent environment..."

if [ ! -w "." ]; then
  echo "[ERR] Current directory is not writable"
  exit 1
fi

# Preflight: ensure all templates exist
missing=0
if [ ! -f "$TEMPLATES_DIR/AGENTS.md" ]; then
  echo "[ERR] Template not found: AGENTS.md"
  missing=1
fi
for file in "${FILES[@]}"; do
  if [ ! -f "$RULES_TEMPLATES_DIR/$file" ]; then
    echo "[ERR] Template not found: $file"
    missing=1
  fi
done
if [ "$missing" -ne 0 ]; then
  echo "[ERR] Aborting: required templates missing."
  exit 1
fi

# Ensure root directory exists
if [ ! -d "$RULES_DIR" ]; then
  mkdir "$RULES_DIR"
  echo "[OK] Created directory: $RULES_DIR/"
fi

for file in "${FILES[@]}"; do
  if [ -f "$RULES_TEMPLATES_DIR/$file" ]; then
    target_path="$RULES_DIR/$file"
    if [ -f "$target_path" ]; then
      echo "[WARN] $target_path already exists, skipping"
    else
      cp "$RULES_TEMPLATES_DIR/$file" "$target_path"
      echo "[OK] Copied: $target_path"
    fi
  else
    echo "[ERR] Template not found: $file"  # unreachable due to preflight
  fi
done

# Copy AGENTS.md
if [ -f "$TEMPLATES_DIR/AGENTS.md" ]; then
  if [ -f "./AGENTS.md" ]; then
    echo "[WARN] AGENTS.md already exists, skipping"
  else
    cp "$TEMPLATES_DIR/AGENTS.md" ./AGENTS.md
    echo "[OK] Copied: AGENTS.md"
  fi
fi

# Create README.md if not present
if [ ! -f "README.md" ]; then
  touch README.md
  echo "[OK] README.md created"
fi

# Optional: add skills
if [ "$WITH_SKILLS" = true ]; then
  run_helper add-skills "$AGENT47_HOME/scripts/add-skills"
fi

# Optional: add prompt
case "$PROMPT_CHOICE" in
  "")
    ;;
  base)
    run_helper add-agent-prompt-base "$AGENT47_HOME/scripts/add-agent-prompt-base"
    ;;
  skills)
    run_helper add-agent-prompt-skills "$AGENT47_HOME/scripts/add-agent-prompt-skills"
    run_helper reload-skills "$AGENT47_HOME/scripts/reload-skills"
    ;;
  sdd)
    run_helper add-agent-prompt-sdd "$AGENT47_HOME/scripts/add-agent-prompt-sdd"
    run_helper reload-skills "$AGENT47_HOME/scripts/reload-skills"
    ;;
  *)
    echo "[ERR] Invalid prompt choice: $PROMPT_CHOICE (use base|skills|sdd)"
    exit 1
    ;;
esac

echo "[OK] Agent environment ready"
