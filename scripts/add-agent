#!/bin/bash

AGENT47_HOME="$HOME/.agent47"
TEMPLATES_DIR="$AGENT47_HOME/templates"

FILES=(
  "AGENTS.md"
  "rules-mobile.yaml"
  "rules-frontend.yaml"
  "rules-backend.yaml"
)

WITH_SKILLS=false
PROMPT_CHOICE=""

run_helper() {
  local cmd="$1"
  local fallback="$2"
  local args=("${@:3}")

  if command -v "$cmd" >/dev/null 2>&1; then
    "$cmd" "${args[@]}"
    return $?
  fi

  if [ -n "$fallback" ] && [ -x "$fallback" ]; then
    "$fallback" "${args[@]}"
    return $?
  fi

  echo "[ERR] $cmd not found (checked PATH${fallback:+ and $fallback})"
  return 1
}

usage() {
  echo "Usage: add-agent [--with-skills] [--prompt base|skills|sdd]"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --with-skills)
      WITH_SKILLS=true
      shift
      ;;
    --prompt)
      if [[ -z "$2" ]]; then
        usage
        exit 1
      fi
      PROMPT_CHOICE="$2"
      shift 2
      ;;
    *)
      usage
      exit 1
      ;;
  esac
done

echo "[INFO] Initializing agent environment..."

for file in "${FILES[@]}"; do
  if [ -f "$TEMPLATES_DIR/$file" ]; then
    if [ -f "./$file" ]; then
      echo "[WARN] $file already exists, skipping"
    else
      cp "$TEMPLATES_DIR/$file" .
      echo "[OK] Copied: $file"
    fi
  else
    echo "[ERR] Template not found: $file"
  fi
done

# Create README.md if not present
if [ ! -f "README.md" ]; then
  touch README.md
  echo "[OK] README.md created"
fi

# Optional: add skills
if [ "$WITH_SKILLS" = true ]; then
  run_helper add-skills "$AGENT47_HOME/scripts/add-skills"
fi

# Optional: add prompt
case "$PROMPT_CHOICE" in
  "")
    ;;
  base)
    run_helper add-agent-prompt-base "$AGENT47_HOME/scripts/add-agent-prompt-base"
    ;;
  skills)
    run_helper add-agent-prompt-skills "$AGENT47_HOME/scripts/add-agent-prompt-skills"
    run_helper reload-skills "$AGENT47_HOME/scripts/reload-skills"
    ;;
  sdd)
    run_helper add-agent-prompt-sdd "$AGENT47_HOME/scripts/add-agent-prompt-sdd"
    run_helper reload-skills "$AGENT47_HOME/scripts/reload-skills"
    ;;
  *)
    echo "[ERR] Invalid prompt choice: $PROMPT_CHOICE (use base|skills|sdd)"
    ;;
esac

echo "[OK] Agent environment ready"
