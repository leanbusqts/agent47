#!/bin/bash

AGENT47_HOME="$HOME/.agent47"
TEMPLATES_DIR="$AGENT47_HOME/templates/skills"
HELPERS_FILE="$AGENT47_HOME/scripts/skill-utils.sh"

SKILLS_DIR="skills"
SKILL_LIST=(
  analyze
  implement
  review
  refactor
  optimize
  plan
  spec-clarify
  troubleshoot
)

if [ -f "$HELPERS_FILE" ]; then
  # shellcheck disable=SC1090
  source "$HELPERS_FILE"
else
  echo "[ERR] Helper not found: $HELPERS_FILE"
  exit 1
fi

echo "[INFO] Initializing agent skills..."

if [ ! -d "$SKILLS_DIR" ]; then
  mkdir "$SKILLS_DIR"
  echo "[OK] Created directory: $SKILLS_DIR/"
else
  echo "[INFO] Directory already exists: $SKILLS_DIR/"
fi

for skill in "${SKILL_LIST[@]}"; do
  src="$TEMPLATES_DIR/$skill"
  dest="$SKILLS_DIR/$skill"

  if [ ! -d "$src" ]; then
    echo "[ERR] Template not found: $skill"
    continue
  fi

  if [ -d "$dest" ]; then
    if [ ! -f "$dest/SKILL.md" ]; then
      cp "$src/SKILL.md" "$dest/SKILL.md"
      echo "[OK] Restored SKILL.md: $skill"
    else
      echo "[INFO] Skill exists, skipping copy: $skill"
    fi
  else
    cp -R "$src" "$dest"
    echo "[OK] Created skill: $skill"
  fi

  validate_skill "$dest/SKILL.md" || true
done

write_available_skills "$SKILLS_DIR" "$SKILLS_DIR/AVAILABLE_SKILLS.xml"

echo "[OK] Skills setup complete."
